{% extends "admin/base_site.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<div class="header-section">
  <h1 class="page-title">
    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="#6A0DAD" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-line-chart" style="vertical-align: middle; margin-right: 8px;">
        <path d="M3 3v18h18"/><path d="m18 10-5 5-5-5-4 4"/>
    </svg>
    All Users Attendance
  </h1>
</div>

<div class="select-wrapper">
  <select name="month" class="filter-select">
    {% for m in 1|get_range:12 %}
      <option value="{{ m }}" {% if m == selected_month %}selected{% endif %}>
        {{ m|date:"F" }}
      </option>
    {% endfor %}
    </select>
</div>

<div class="select-wrapper">
  <select name="year" class="filter-select">
    {% for y in 2023|get_range:2026 %}
      <option>ption value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
    {% endfor %}
  </select>
</div>



<div class="filter-section">
  <form method="get" class="filter-form">
    <div class="search-input-wrapper">
      <input type="text" name="search" placeholder="ðŸ” Search by name..." value="{{ search_query }}" class="search-input">
    </div>
    <div class="select-wrapper">
      <select name="user_type" class="filter-select">
        <option value="">All Types</option>
        <option value="student" {% if user_type_filter == "student" %}selected{% endif %}>Students</option>
        <option value="faculty" {% if user_type_filter == "faculty" %}selected{% endif %}>Faculty</option>
      </select>
    </div>
    <button type="submit" class="filter-button">Filter</button>
  </form>
</div>

<div class="user-cards-grid new-layout">
  {% for u in user_data %}
  <div class="card modern-card new-card-style" onclick="openModal('{{ u.user.id }}')">
    <div class="card-icons">
        <span class="icon pin-icon"></span>
        <span class="icon options-icon"></span>
    </div>
    <div class="card-content-wrapper">
      <img 
        src="{% if u.user.userface.face_image %}
                {{ u.user.userface.face_image.url }}
              {% elif u.user.username %}
                /media/faces/{{ u.user.username }}/{{ u.user.username }}_default.jpg
              {% else %}
                /static/default_profile.png
              {% endif %}"
        alt="{{ u.user.username }}"
        class="profile-img">
        <h3 class="username">{{ u.user.username }}</h3>
        <span class="user-info-tag">{{ u.attendance_percentage }}% Attendance</span>
        <p class="contact-info text-secondary">Present: {{ u.present_days }}</p>
        <p class="contact-info text-secondary">Absent: {{ u.absent_days }}</p>
    </div>
  </div>

  <div id="modal-{{ u.user.id }}" class="modal modern-modal">
    <div class="modal-content modern-modal-content">
      <span class="close modern-close" onclick="closeModal('{{ u.user.id }}')">&times;</span>
      <div class="modal-user-info">
       <img 
  src="{% if u.user.userface.face_image %}
          {{ u.user.userface.face_image.url }}
        {% elif u.user.username %}
          /media/faces/{{ u.user.username }}/{{ u.user.username }}_default.jpg
        {% else %}
          /static/default_profile.png
        {% endif %}"
  class="modal-img"
  alt="{{ u.user.username }}">        <div class="modal-info-details">
          <h2 class="modal-username">{{ u.user.username }}</h2>
          <p class="text-secondary"><strong>Email:</strong> {{ u.user.email }}</p>
          <p class="text-secondary"><strong>Enrollment:</strong> {{ u.user.enrollment_no }}</p>
          <p class="text-secondary"><strong>Type:</strong> <span class="user-type-tag-modal">{{ u.user.user_type|title }}</span></p>
          <a href="{% url 'admin:accounts_customuser_change' u.user.id %}" class="btn edit-btn" onclick="event.stopPropagation();">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
              Edit Profile
          </a>
        </div>
      </div>

      <h3 class="modal-section-title">Attendance Summary</h3>
      <p class="modal-attendance-summary">Present: <span class="text-success">{{ u.present_days }}</span> | Absent: <span class="text-danger">{{ u.absent_days }}</span> | Percentage: <span class="text-primary">{{ u.attendance_percentage }}%</span></p>

<div class="modal-buttons">
  <a href="?export=attendance&user={{ u.user.id }}" class="btn download-btn primary-download-btn">
    Attendance CSV
  </a>
  <a href="?export=leave&user={{ u.user.id }}" class="btn download-btn secondary-download-btn">
    Leave CSV
  </a>
  <a href="?export=monthly&user={{ u.user.id }}&month={{ selected_month }}&year={{ selected_year }}" 
     class="btn download-btn"
     style="background: linear-gradient(90deg, #9b59b6, #6a1b9a);">
    Monthly Summary CSV
  </a>
</div>

      <h3 class="modal-section-title">Attendance History</h3>
      <table class="table modern-table">
        <thead>
          <tr><th>Date</th><th>Status</th></tr>
        </thead>
        <tbody>
          {% for r in u.records %}
            <tr><td>{{ r.date }}</td><td>{{ r.status }}</td></tr>
          {% empty %}
            <tr><td colspan="2" class="text-center">No attendance records found</td></tr>
          {% endfor %}
        </tbody>
      </table>

      <h3 class="modal-section-title">Attendance Summary</h3>
<p class="modal-attendance-summary">
  Present: <span class="text-success">{{ u.present_days }}</span> | 
  Absent: <span class="text-danger">{{ u.absent_days }}</span> | 
  Percentage: <span class="text-primary">{{ u.attendance_percentage }}%</span>
</p>

      <h3 class="modal-section-title">Leave History</h3>
      <table class="table modern-table">
        <thead>
          <tr><th>From</th><th>To</th><th>Reason</th><th>Status</th></tr>
        </thead>
        <tbody>
          {% for l in u.leaves %}
            <tr><td>{{ l.start_date }}</td><td>{{ l.end_date }}</td><td>{{ l.reason }}</td><td>{{ l.status }}</td></tr>
          {% empty %}
            <tr><td colspan="4" class="text-center">No leaves found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}
</div>

<style>
/* --- Color Variables --- */
:root {
    --primary-purple: #6A0DAD; /* Darker Purple for accents/headings */
    --light-purple: #8A2BE2; /* Primary button/tag color */
    --lighter-purple: #f3e6fc; /* Lightest background for cards/tables */
    --text-dark: #333;
    --text-secondary: #555;
    --success: #4CAF50;
    --danger: #E53935;
    --card-padding-x: 20px;
}

.edit-btn {
    display: inline-block;
    margin-top: 12px;
    padding: 8px 15px;
    font-size: 0.9em;
    font-weight: 600;
    color: white;
    background-color: #4CAF50;
    border-radius: 10px;
    text-decoration: none;
    transition: background-color 0.2s;
}
.edit-btn:hover {
    background-color: #388E3C;
}

/* --- Base/Utility Styles --- */
body { font-family: 'Inter', sans-serif; background-color: #f7f7f7; }
.text-primary { color: var(--primary-purple); font-weight: 600; }
.text-success { color: var(--success); font-weight: 600; }
.text-danger { color: var(--danger); font-weight: 600; }
.text-secondary { color: var(--text-secondary); }
.text-center { text-align: center; }

/* --- Header & Filter (No Change) --- */
.header-section { margin-bottom: 30px; padding-bottom: 10px; border-bottom: 1px solid #eee; }
.page-title { font-size: 1.8em; font-weight: 700; color: var(--text-dark); margin: 0; }
.filter-section { margin-bottom: 30px; }
.filter-form { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
.search-input-wrapper { flex-grow: 1; min-width: 250px; }
.search-input, .filter-select { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1em; color: var(--text-dark); transition: all 0.2s; }
.search-input:focus, .filter-select:focus { outline: none; border-color: var(--light-purple); box-shadow: 0 0 0 3px rgba(138, 43, 226, 0.1); }
.filter-select { background-color: white; appearance: none; padding-right: 35px; }
.filter-button { padding: 10px 20px; background-color: var(--light-purple); color: white; border: none; border-radius: 10px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
.filter-button:hover { background-color: var(--primary-purple); transform: translateY(-1px); }


/* --- User Cards Grid --- */
.user-cards-grid.new-layout {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

/* --- New Card Styles (Minimal Contact Look) --- */
.modern-card.new-card-style {
    height:max-content;
    width: 290px;
    background: white;
    border-radius: 18px;
    box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); /* Lighter shadow */
    text-align: center;
    padding: 0; /* Important: remove general padding */
    cursor: pointer;
    transition: all 0.3s ease-in-out;
    position: relative;
    overflow: hidden;
    border: 1px solid #f0f0f0;
}
.modern-card.new-card-style:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(106, 13, 173, 0.1);
}

.card-icons {
    position: absolute;
    top: 15px;
    right: 15px;
    left: 15px;
    display: flex;
    justify-content: space-between;
}
.icon {
    width: 24px; height: 24px; border-radius: 50%; background-color: transparent;
    display: flex; align-items: center; justify-content: center; opacity: 0.8;
}
/* Pin icon on the left */
.pin-icon { background-color: var(--lighter-purple); opacity: 1; }
.pin-icon::before { content: 'ðŸ”—'; font-size: 14px; color: var(--light-purple); opacity: 0.8; }
/* Options icon on the right */
.options-icon::before { content: 'â€¢â€¢â€¢'; font-size: 14px; color: var(--text-secondary); opacity: 0.8; }

.card-content-wrapper {
    padding: 40px var(--card-padding-x) 25px var(--card-padding-x);
    display: flex;
    flex-direction: column;
    align-items: center;
}

    .row {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin-right: -15px;
    margin-left: -15px;
    flex-direction: column;
}

.profile-img {
    width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
    margin-bottom: 10px;
    border: 3px solid #eee;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.username {
    font-size: 1.25em;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 5px;
}

.user-info-tag {
    /* Used for the "job title" line in the image, adapted for attendance percentage */
    font-size: 0.9em;
    color: var(--primary-purple);
    background-color: var(--lighter-purple);
    padding: 4px 12px;
    border-radius: 20px;
    display: inline-block;
    font-weight: 500;
    margin-bottom: 15px;
}

.contact-info {
    /* Used for phone/email lines in the image, adapted for attendance days */
    font-size: 0.95em;
    color: var(--light-purple);
    margin: 3px 0;
}


/* --- Modal Styles (Retained for consistency) --- */
.modern-modal { display:none; position:fixed; z-index:999; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; }
.modern-modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 870px; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2); position: relative; }
.modern-close { position: absolute; right: 25px; top: 20px; font-size: 2.2em; color: #aaa; cursor: pointer; transition: color 0.2s; }
.modern-close:hover { color: var(--primary-purple); }
.modal-user-info { display: flex; align-items: center; gap: 25px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #f0f0f0; }
.modal-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 5px solid var(--lighter-purple); }
.modal-info-details h2 { font-size: 2em; font-weight: 700; color: var(--primary-purple); margin-bottom: 8px; }
.user-type-tag-modal { background-color: var(--lighter-purple); color: var(--primary-purple); padding: 3px 10px; border-radius: 15px; font-weight: 500; font-size: 0.9em; }
.modal-section-title { font-size: 1.5em; font-weight: 600; color: var(--text-dark); margin-top: 30px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px solid #eee; }
.modal-attendance-summary { font-size: 1.1em; color: var(--text-secondary); margin-bottom: 25px; }
.modal-buttons { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
.download-btn {
    padding: 10px 20px;
    background: linear-gradient(90deg, var(--primary-purple), var(--light-purple));
    color: white;
    border-radius: 10px;
    font-size: 1em;
    font-weight: 600;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: background 0.3s ease, transform 0.1s ease;
    border: none;
}

.download-btn:hover {
    background: linear-gradient(90deg, #7d3fcf, #9b59b6);
    transform: translateY(-2px);
}

.primary-download-btn {
    background: linear-gradient(90deg, #6A0DAD, #8A2BE2);
}

.secondary-download-btn {
    background: linear-gradient(90deg, #5e35b1, #9b59b6);
}

.primary-download-btn:hover,
.secondary-download-btn:hover {
    background: linear-gradient(90deg, #7d3fcf, #9b59b6);
}
.modern-table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03); }
.modern-table th, .modern-table td { padding: 12px 18px; text-align: left; border-bottom: 1px solid #f5f5f5; }
.modern-table thead th { background-color: var(--lighter-purple); color: var(--primary-purple); font-weight: 600; text-transform: uppercase; font-size: 0.85em; }
.modern-table tbody tr:nth-child(even) { background-color: #fcfcff; }
.modern-table tbody tr:hover { background-color: #f5f0ff; }
.modern-table tbody tr:last-child td { border-bottom: none; }

/* --- Mobile Responsiveness --- */
@media (max-width: 768px) {

    .row {
    display: -ms-flexbox;
    display: flex;
    -ms-flex-wrap: wrap;
    flex-wrap: wrap;
    margin-right: -15px;
    margin-left: -15px;
    flex-direction: column;
}
    .filter-form {
        flex-direction: column;
        gap: 10px;
    }
    .search-input-wrapper, .select-wrapper, .filter-button {
        width: 100%;
        min-width: unset;
    }
    .user-cards-grid.new-layout {
        /* On small screens, stack them in 2 columns */
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    }
    .modern-modal-content {
        padding: 20px;
        margin: 10px;
    }
    .modal-user-info {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    .modal-user-info .modal-info-details {
        align-items: center;
        display: flex;
        flex-direction: column;
    }
    .modal-buttons {
        flex-direction: column;
    }
    .download-btn {
        justify-content: center;
    }
    .modern-table th, .modern-table td {
        padding: 10px 12px;
        font-size: 0.9em;
    }
}
</style>

<script>
function openModal(id) {
    document.getElementById('modal-' + id).style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function closeModal(id) {
    // Stop event propagation to prevent the card's openModal from firing
    if (event) event.stopPropagation();
    document.getElementById('modal-' + id).style.display = 'none';
    document.body.style.overflow = ''; // Restore scrolling
}
</script>
{% endblock %}